import sys
sys.path.insert(0, '../../')
from common import *

def setup(k, iv):
    n = [1]*128
    l = [1]*128
    
    n[0:128] = k
    l[0:96] = iv
    return n, l

def init(n, l):
    for i in range(2*128):
        # print(i, b2h(n+l, 256))
       
        tl = l[0] ^ l[7] ^ l[38] ^ l[70] ^ l[81] ^ l[96]
        tn = l[0] ^ n[0] ^ n[26] ^ n[56] ^ n[91] ^ n[96] \
            ^ (n[3] & n[67]) ^ (n[11] & n[13]) ^ (n[17] & n[18]) \
            ^ (n[27] & n[59]) ^ (n[40] & n[48]) ^ (n[61] & n[65]) \
            ^ (n[68] & n[84]) ^ (n[22] & n[24] & n[25]) ^ (n[70] & n[78] & n[82]) \
            ^ (n[88] & n[92] & n[93] & n[95])

        z = (n[12] & l[8]) ^ (l[13] & l[20]) ^ (n[95] & l[42]) ^ (l[60] & l[79]) ^ (n[12] & n[95] & l[94]) \
            ^ l[93] ^ n[2] ^ n[15] ^ n[36] ^ n[45] ^ n[64] ^ n[73] ^ n[89]
        
        n = n[1:128] + [tn ^ z]
        l = l[1:128] + [tl ^ z]

    return n, l

def stream(n, l, _n):
    z = [0] * _n
    for i in range(_n):

        tl = l[0] ^ l[7] ^ l[38] ^ l[70] ^ l[81] ^ l[96]
        tn = l[0] ^ n[0] ^ n[26] ^ n[56] ^ n[91] ^ n[96] \
            ^ (n[3] & n[67]) ^ (n[11] & n[13]) ^ (n[17] & n[18]) \
            ^ (n[27] & n[59]) ^ (n[40] & n[48]) ^ (n[61] & n[65]) \
            ^ (n[68] & n[84]) ^ (n[22] & n[24] & n[25]) ^ (n[70] & n[78] & n[82]) \
            ^ (n[88] & n[92] & n[93] & n[95])

        z[i] = (n[12] & l[8]) ^ (l[13] & l[20]) ^ (n[95] & l[42]) ^ (l[60] & l[79]) ^ (n[12] & n[95] & l[94]) \
            ^ l[93] ^ n[2] ^ n[15] ^ n[36] ^ n[45] ^ n[64] ^ n[73] ^ n[89]
        
        n = n[1:128] + [tn]
        l = l[1:128] + [tl]

    return z

def run(k, iv, _n=256):
    _k  = i2b(k, 128)
    _iv = i2b(iv, 96)

    n, l  = setup(_k, _iv)
    n, l  = init(n, l)
    return stream(n, l, _n)

